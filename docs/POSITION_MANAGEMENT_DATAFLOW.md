# 仓位管理数据流图

## 完整交易生命周期数据流

```
┌─────────────────────────────────────────────────────────────────────┐
│                         信号源 (Signal Source)                       │
│                                                                       │
│  • TradingView Webhook                                               │
│  • Technical Analysis                                                 │
│  • AI Model Output                                                   │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         │ Trading Signal
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      DecisionEngine                                  │
│                     (决策引擎)                                        │
│                                                                       │
│  1. 信号验证                                                          │
│  2. 市场条件分析                                                      │
│  3. 生成交易建议                                                      │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         │ Trade Recommendation
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    PortfolioManager                                  │
│                   (组合管理器 - 协调层)                               │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │   can_open_new_position(symbol, size)        │                   │
│  └──────────────┬───────────────────────────────┘                   │
│                 │                                                     │
│                 ├─→ 检查最大仓位数                                   │
│                 ├─→ 检查单仓大小限制                                 │
│                 ├─→ 检查可用资金                                     │
│                 ├─→ 检查总暴露                                       │
│                 └─→ 检查是否已有仓位                                 │
│                                                                       │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         │ if approved
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       RiskManager                                    │
│                     (风险管理器)                                      │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  calculate_position_size()                   │                   │
│  │                                               │                   │
│  │  输入:                                        │                   │
│  │    • entry_price                             │                   │
│  │    • stop_loss_price                         │                   │
│  │    • available_capital                       │                   │
│  │    • confidence                              │                   │
│  │                                               │                   │
│  │  计算:                                        │                   │
│  │    risk_amount = capital × risk_pct          │                   │
│  │    price_risk = |entry - stop_loss|          │                   │
│  │    quantity = risk_amount / price_risk       │                   │
│  │                                               │                   │
│  │  输出:                                        │                   │
│  │    • quantity                                │                   │
│  │    • notional_value                          │                   │
│  │    • recommended_leverage                    │                   │
│  └──────────────────────────────────────────────┘                   │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  assess_trade_risk()                         │                   │
│  │                                               │                   │
│  │  检查:                                        │                   │
│  │    ✓ Position size limit                    │                   │
│  │    ✓ Portfolio heat limit                   │                   │
│  │    ✓ Concurrent positions limit             │                   │
│  │    ✓ Available capital                      │                   │
│  │                                               │                   │
│  │  输出:                                        │                   │
│  │    • is_acceptable (bool)                    │                   │
│  │    • risks (list)                            │                   │
│  │    • warnings (list)                         │                   │
│  │    • metrics (dict)                          │                   │
│  └──────────────────────────────────────────────┘                   │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         │ if risk acceptable
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     PositionManager                                  │
│                    (仓位管理器 - 执行层)                              │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  open_position()                             │                   │
│  │                                               │                   │
│  │  步骤:                                        │                   │
│  │  1. 生成 position_id (UUID)                  │                   │
│  │  2. 计算指标:                                 │                   │
│  │     • notional_value                         │                   │
│  │     • risk_amount                            │                   │
│  │     • reward_potential                       │                   │
│  │     • risk_reward_ratio                      │                   │
│  │  3. 创建 Position 对象                       │                   │
│  │  4. 添加到 positions 字典                    │                   │
│  │  5. 更新可用资金:                             │                   │
│  │     margin = notional / leverage             │                   │
│  │     capital -= margin                        │                   │
│  │  6. 记录交易历史                              │                   │
│  │  7. 保存到数据库                              │                   │
│  └──────────────┬───────────────────────────────┘                   │
│                 │                                                     │
└─────────────────┼─────────────────────────────────────────────────────┘
                  │
                  │ Position Created
                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   PositionDatabase                                   │
│                  (持久化层 - SQLite)                                  │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  save_position()                             │                   │
│  │                                               │                   │
│  │  INSERT INTO positions:                      │                   │
│  │    • position_id                             │                   │
│  │    • session_id                              │                   │
│  │    • symbol, side, quantity                  │                   │
│  │    • entry_price, leverage                   │                   │
│  │    • profit_target, stop_loss_price          │                   │
│  │    • risk_usd, confidence                    │                   │
│  │    • opened_at                               │                   │
│  │    • status = 'open'                         │                   │
│  └──────────────────────────────────────────────┘                   │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  save_trade_record()                         │                   │
│  │                                               │                   │
│  │  INSERT INTO trade_records:                  │                   │
│  │    • session_id, position_id                 │                   │
│  │    • timestamp, action = 'OPEN'              │                   │
│  │    • symbol, side, quantity, price           │                   │
│  │    • record_json                             │                   │
│  └──────────────────────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════
                         持仓监控循环
═══════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────┐
│                   定时任务 (每分钟)                                   │
│                   Scheduled Monitor                                  │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         ▼
                  获取实时价格
                  Get Current Prices
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│              PortfolioManager.update_all_positions()                 │
│                                                                       │
│              ┌──────────────────────────────┐                        │
│              │  PositionManager             │                        │
│              │  .update_positions(prices)   │                        │
│              └──────────┬───────────────────┘                        │
│                         │                                             │
│                         │ 对每个仓位:                                 │
│                         │                                             │
│              ┌──────────▼───────────────────┐                        │
│              │  1. 更新 current_price        │                        │
│              │                               │                        │
│              │  2. 计算 unrealized_pnl:      │                        │
│              │     LONG: (current - entry)   │                        │
│              │           × quantity          │                        │
│              │     SHORT: (entry - current)  │                        │
│              │            × quantity         │                        │
│              └──────────┬───────────────────┘                        │
│                         │                                             │
│              ┌──────────▼───────────────────┐                        │
│              │  3. 检查止损条件              │                        │
│              │                               │                        │
│              │  LONG:                        │                        │
│              │    if current <= stop_loss:   │                        │
│              │      → close_position()       │                        │
│              │                               │                        │
│              │  SHORT:                       │                        │
│              │    if current >= stop_loss:   │                        │
│              │      → close_position()       │                        │
│              └──────────┬───────────────────┘                        │
│                         │                                             │
│              ┌──────────▼───────────────────┐                        │
│              │  4. 检查止盈条件              │                        │
│              │                               │                        │
│              │  LONG:                        │                        │
│              │    if current >= target:      │                        │
│              │      → close_position()       │                        │
│              │                               │                        │
│              │  SHORT:                       │                        │
│              │    if current <= target:      │                        │
│              │      → close_position()       │                        │
│              └───────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│           PortfolioManager.check_all_invalidations()                 │
│                                                                       │
│           ┌──────────────────────────────┐                           │
│           │  PositionManager             │                           │
│           │  .check_invalidation_        │                           │
│           │   conditions()               │                           │
│           └──────────┬───────────────────┘                           │
│                      │                                                │
│                      │ 对每个仓位:                                    │
│                      │                                                │
│           ┌──────────▼───────────────────┐                           │
│           │  1. 获取最近K线数据           │                           │
│           │                               │                           │
│           │  2. 检查失效条件:             │                           │
│           │     • 关键价位突破            │                           │
│           │     • 形态破坏                │                           │
│           │     • 趋势反转                │                           │
│           │                               │                           │
│           │  3. 如果触发:                 │                           │
│           │     → close_position()        │                           │
│           │     reason: "invalidation"    │                           │
│           └───────────────────────────────┘                           │
└─────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  PortfolioManager.get_portfolio_summary()            │
│                                                                       │
│  收集数据:                                                            │
│    • 所有开仓                                                         │
│    • 资金状态                                                         │
│    • 盈亏计算                                                         │
│    • 风险指标                                                         │
│    • 绩效统计                                                         │
│                                                                       │
│  生成: PortfolioSnapshot                                             │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│               PositionDatabase.save_snapshot()                       │
│                                                                       │
│  INSERT INTO portfolio_snapshots:                                    │
│    • session_id, timestamp                                           │
│    • total_capital, available_capital                                │
│    • unrealized_pnl, realized_pnl                                    │
│    • portfolio_heat, exposure_pct                                    │
│    • performance metrics                                             │
│    • snapshot_json (完整快照)                                        │
└─────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════
                         平仓流程
═══════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────┐
│                      触发条件                                         │
│                                                                       │
│  • 止损触发 (Stop Loss Hit)                                          │
│  • 止盈触发 (Take Profit Hit)                                        │
│  • 失效条件触发 (Invalidation Triggered)                             │
│  • 反向信号 (Signal Reversal)                                        │
│  • 手动平仓 (Manual Close)                                           │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                PositionManager.close_position()                      │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  输入:                                        │                   │
│  │    • symbol                                  │                   │
│  │    • exit_price                              │                   │
│  │    • exit_reason                             │                   │
│  │    • signal_id (可选)                        │                   │
│  └──────────────────────────────────────────────┘                   │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  步骤 1: 查找仓位                             │                   │
│  │    position = positions[symbol]              │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  步骤 2: 计算已实现盈亏                       │                   │
│  │                                               │                   │
│  │  LONG:                                        │                   │
│  │    pnl = (exit - entry) × quantity           │                   │
│  │                                               │                   │
│  │  SHORT:                                       │                   │
│  │    pnl = (entry - exit) × quantity           │                   │
│  │                                               │                   │
│  │  pnl_pct = (pnl / notional) × 100            │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  步骤 3: 计算持仓时长                         │                   │
│  │    duration = (closed_at - opened_at)        │                   │
│  │               .total_seconds() / 3600        │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  步骤 4: 创建 ClosedPosition 对象             │                   │
│  │    • position_id, session_id                 │                   │
│  │    • symbol, side, quantity                  │                   │
│  │    • entry_price, exit_price                 │                   │
│  │    • realized_pnl, realized_pnl_pct          │                   │
│  │    • opened_at, closed_at                    │                   │
│  │    • holding_duration                        │                   │
│  │    • exit_reason, exit_signal_id             │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  步骤 5: 更新可用资金                         │                   │
│  │                                               │                   │
│  │  margin_returned = notional / leverage       │                   │
│  │  current_capital += margin_returned + pnl    │                   │
│  │                                               │                   │
│  │  (返还保证金 + 盈亏)                          │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  步骤 6: 更新仓位状态                         │                   │
│  │    • 从 positions 字典移除                   │                   │
│  │    • 添加到 closed_positions 列表            │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  步骤 7: 记录交易历史                         │                   │
│  │    _record_trade("CLOSE", ...)               │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
└─────────────┼─────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    PositionDatabase                                  │
│                                                                       │
│  ┌──────────────────────────────────────────────┐                   │
│  │  save_closed_position()                      │                   │
│  │                                               │                   │
│  │  INSERT INTO closed_positions:               │                   │
│  │    • position_id, session_id                 │                   │
│  │    • symbol, side, quantity                  │                   │
│  │    • entry_price, exit_price                 │                   │
│  │    • realized_pnl, realized_pnl_pct          │                   │
│  │    • opened_at, closed_at                    │                   │
│  │    • holding_duration                        │                   │
│  │    • exit_reason, exit_signal_id             │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  update_position_status()                    │                   │
│  │                                               │                   │
│  │  UPDATE positions                            │                   │
│  │  SET status = 'closed'                       │                   │
│  │  WHERE position_id = ?                       │                   │
│  └──────────┬───────────────────────────────────┘                   │
│             │                                                         │
│  ┌──────────▼───────────────────────────────────┐                   │
│  │  save_trade_record()                         │                   │
│  │                                               │                   │
│  │  INSERT INTO trade_records:                  │                   │
│  │    • action = 'CLOSE'                        │                   │
│  │    • pnl = realized_pnl                      │                   │
│  │    • record_json                             │                   │
│  └──────────────────────────────────────────────┘                   │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                PerformanceAnalytics                                  │
│                                                                       │
│  add_closed_position(closed_position)                                │
│    • 添加到分析列表                                                   │
│    • 更新统计指标                                                     │
│    • 计算胜率                                                         │
│    • 计算盈利因子                                                     │
└─────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════
                    风险监控和报警系统
═══════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────┐
│                  持续监控 (Continuous Monitoring)                    │
└────────────────────────┬──────────────────────────────────────────────┘
                         │
            ┌────────────┼────────────┐
            │            │            │
            ▼            ▼            ▼
    ┌───────────┐  ┌───────────┐  ┌───────────┐
    │ 组合热度   │  │ 保证金    │  │ 最大回撤   │
    │ Portfolio │  │ Margin    │  │ Max       │
    │ Heat      │  │ Level     │  │ Drawdown  │
    └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
          │              │              │
          ▼              ▼              ▼
    ┌─────────────────────────────────────┐
    │      风险级别判断                    │
    │      Risk Level Assessment          │
    └─────────────────┬───────────────────┘
                      │
          ┌───────────┼───────────┐
          │           │           │
          ▼           ▼           ▼
    ┌─────────┐ ┌─────────┐ ┌─────────┐
    │  正常   │ │  警告   │ │  严重   │
    │ Normal  │ │Warning  │ │Critical │
    └────┬────┘ └────┬────┘ └────┬────┘
         │           │           │
         │           ▼           ▼
         │      ┌─────────────────────┐
         │      │  发送通知            │
         │      │  Send Notification  │
         │      └─────────────────────┘
         │           │
         │           ▼
         │      ┌─────────────────────┐
         │      │  记录日志            │
         │      │  Log Event          │
         │      └─────────────────────┘
         │
         ▼
    ┌─────────────────────────────────┐
    │  继续正常监控                    │
    │  Continue Normal Monitoring     │
    └─────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════
                      数据库关系图
═══════════════════════════════════════════════════════════════════════

┌──────────────────────┐
│  trading_sessions    │
│  ────────────────    │
│  PK: session_id      │◄─────────┐
│  user_id             │          │
│  initial_capital     │          │
│  current_capital     │          │
│  config_json         │          │
│  is_active           │          │
└──────────────────────┘          │
                                  │ FK
         ┌────────────────────────┼──────────────┐
         │                        │              │
         ▼                        │              │
┌──────────────────────┐          │              │
│     positions        │          │              │
│  ────────────────    │          │              │
│  PK: position_id     │          │              │
│  FK: session_id      ├──────────┘              │
│  symbol              │                         │
│  side                │                         │
│  quantity            │                         │
│  entry_price         │                         │
│  leverage            │                         │
│  profit_target       │                         │
│  stop_loss_price     │                         │
│  risk_usd            │                         │
│  status              │                         │
└──────────────────────┘                         │
                                                 │
         ┌───────────────────────────────────────┤
         │                                       │
         ▼                                       │
┌──────────────────────┐                         │
│  closed_positions    │                         │
│  ────────────────    │                         │
│  PK: position_id     │                         │
│  FK: session_id      ├─────────────────────────┘
│  symbol              │
│  entry_price         │
│  exit_price          │
│  realized_pnl        │
│  realized_pnl_pct    │
│  holding_duration    │
│  exit_reason         │
└──────────────────────┘
                                  │
         ┌────────────────────────┤
         │                        │
         ▼                        ▼
┌──────────────────────┐  ┌──────────────────────┐
│ portfolio_snapshots  │  │   trade_records      │
│  ────────────────    │  │  ────────────────    │
│  PK: id              │  │  PK: id              │
│  FK: session_id      │  │  FK: session_id      │
│  timestamp           │  │  position_id         │
│  total_capital       │  │  timestamp           │
│  unrealized_pnl      │  │  action              │
│  realized_pnl        │  │  symbol              │
│  portfolio_heat      │  │  quantity            │
│  snapshot_json       │  │  price               │
└──────────────────────┘  │  pnl                 │
                          │  record_json         │
                          └──────────────────────┘


═══════════════════════════════════════════════════════════════════════
                    资金流动图
═══════════════════════════════════════════════════════════════════════

初始状态:
┌─────────────────────────────────────────┐
│        Total Capital: $10,000           │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Available: $10,000             │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  In Positions: $0               │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘

开仓后:
┌─────────────────────────────────────────┐
│        Total Capital: $10,000           │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Available: $7,500              │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  In Positions: $2,500           │   │
│  │                                 │   │
│  │  Position 1: BTC/USD            │   │
│  │    Notional: $5,000             │   │
│  │    Leverage: 2x                 │   │
│  │    Margin: $2,500               │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘

盈利平仓后:
┌─────────────────────────────────────────┐
│        Total Capital: $10,300           │
│        (Gain: +$300)                    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Available: $10,300             │   │
│  │    = $7,500 (原可用)            │   │
│  │    + $2,500 (返还保证金)        │   │
│  │    + $300 (盈利)                │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  In Positions: $0               │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘

亏损平仓后:
┌─────────────────────────────────────────┐
│        Total Capital: $9,800            │
│        (Loss: -$200)                    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Available: $9,800              │   │
│  │    = $7,500 (原可用)            │   │
│  │    + $2,500 (返还保证金)        │   │
│  │    - $200 (亏损)                │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  In Positions: $0               │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

## 关键数据结构流转

### Position 对象生命周期

```
创建 (Open)
    ↓
Position {
    status: "open"
    unrealized_pnl: 0
    current_price: entry_price
}
    ↓
更新 (Update) ←──┐
    ↓            │
Position {       │
    status: "open"     │
    unrealized_pnl: ±X │ 循环监控
    current_price: Y   │
}               │
    ↓            │
检查条件 ────────┘
    ↓
平仓 (Close)
    ↓
ClosedPosition {
    realized_pnl: ±X
    exit_reason: "..."
    holding_duration: Z
}
```

---

*数据流图版本: 1.0*
*最后更新: 2025-10-27*

